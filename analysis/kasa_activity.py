# ==================== KASA ACTIVITY ====================
# 10 TL ürünleri kontrolü

import pandas as pd

# 10 TL Ürünleri Ürün Kodları (209 adet)
KASA_AKTIVITESI_KODLARI = {
    '25006448', '12002256', '12002046', '22001972', '12003295', '22002759', '22002500', '11002886', '22002215', '22002214',
    '22002259', '22002349', '16002163', '22002717', '16001587', '13001073', '30000944', '18002488', '17003609', '22002296',
    '22002652', '24004136', '24004137', '12003073', '22002328', '24005228', '24006215', '24005232', '24005231', '24006214',
    '24006212', '16002332', '16002342', '23001397', '16002310', '24001063', '24004020', '13002613', '13002317', '13002506',
    '16002285', '16002219', '16002286', '16002218', '13000258', '13000257', '13000256', '13000260', '13002533', '22002611',
    '22002579', '13002559', '13000187', '13002904', '13000189', '13000190', '13002908', '13001872', '13001874', '30000838',
    '30000926', '22002605', '22002604', '22002603', '12003241', '16002194', '16001734', '25005580', '25000237', '25000049',
    '16002099', '23001367', '23001510', '23001177', '23001403', '23001278', '22002732', '22002576', '22002577', '25006483',
    '23001240', '16002317', '30000958', '30000956', '24005155', '24005154', '24005156', '24005157', '24005153', '22000280',
    '22002773', '22002774', '22002501', '22002225', '22000397', '22001395', '22000396', '16001859', '18002956', '17003542',
    '16002338', '16002339', '16002341', '16002009', '16000856', '22002715', '16002235', '24006067', '24006069', '24006068',
    '24006066', '22002686', '22002687', '22002688', '16002220', '24005291', '24005290', '24006078', '24006084', '24005288',
    '24006082', '24006079', '24005289', '24006085', '22002763', '22002762', '22001032', '18003049', '24006126', '24004420',
    '24005183', '24005649', '24005650', '14002481', '13002315', '22001229', '13002478', '30000880', '24005798', '24005796',
    '24005799', '24005797', '24005795', '24006159', '24003492', '24006171', '24006170', '24006174', '24006172', '24006173',
    '22002640', '22002553', '22002764', '22002223', '22002679', '22002221', '22002224', '22002572', '27002662', '24005441',
    '24005897', '24005898', '24005900', '24006081', '24006080', '16002087', '22002282', '22002283', '24005893', '24005894',
    '23001198', '23001439', '23001195', '23001199', '23000843', '23000034', '23001445', '23001444', '23001443', '23001522',
    '24004381', '24005184', '23001534', '23001533', '18001591', '27002676', '27002677', '16001956', '24003287', '24000005',
    '24002194', '24002192', '24002764', '24003872', '16001983', '18002969', '27001340', '27001148', '27001563', '24004354',
    '24004196', '24004115', '14002424', '24003641', '24004972', '13001481', '24003327', '24000004', '23000122',
}


def load_kasa_activity_codes():
    """Kasa aktivitesi ürün kodlarını döndür"""
    return KASA_AKTIVITESI_KODLARI


def check_kasa_activity_products(df, kasa_kodlari):
    """
    10 TL Ürünleri Kontrolü
    Fiyat değişikliği olan ürünlerde manipülasyon riski
    FORMÜL: Fark + Kısmi (Önceki dahil değil)
    """
    results = []
    
    toplam_adet = 0
    toplam_tutar = 0
    eslesen_urun = 0
    
    for idx, row in df.iterrows():
        kod_raw = row.get('Malzeme Kodu', '')
        kod_str = str(kod_raw).replace('.0', '').strip()
        
        if kod_str in kasa_kodlari:
            eslesen_urun += 1
            fark = row['Fark Miktarı'] if pd.notna(row['Fark Miktarı']) else 0
            kismi = row['Kısmi Envanter Miktarı'] if pd.notna(row['Kısmi Envanter Miktarı']) else 0
            toplam = fark + kismi
            
            fark_tutari = row.get('Fark Tutarı', 0) or 0
            kismi_tutari = row.get('Kısmi Envanter Tutarı', 0) or 0
            urun_toplam_tutar = fark_tutari + kismi_tutari
            
            toplam_adet += toplam
            toplam_tutar += urun_toplam_tutar
            
            if toplam != 0:
                if toplam > 0:
                    durum = "FAZLA (+)"
                else:
                    durum = "AÇIK (-)"
                
                results.append({
                    'Malzeme Kodu': kod_str,
                    'Malzeme Adı': row.get('Malzeme Adı', ''),
                    'Fark': fark,
                    'Kısmi': kismi,
                    'TOPLAM': toplam,
                    'Tutar': urun_toplam_tutar,
                    'Durum': durum
                })
    
    result_df = pd.DataFrame(results)
    if len(result_df) > 0:
        result_df['_sort'] = result_df['TOPLAM'].apply(lambda x: 0 if x > 0 else 1)
        result_df = result_df.sort_values(['_sort', 'TOPLAM'], ascending=[True, False])
        result_df = result_df.drop('_sort', axis=1)
    
    summary = {
        'toplam_urun': eslesen_urun,
        'sorunlu_urun': len(results),
        'toplam_adet': toplam_adet,
        'toplam_tutar': toplam_tutar
    }
    
    return result_df, summary
